<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>药品质量回溯系统 - 指标设置</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta http-equiv="Access-Control-Allow-Origin" content="*" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=no" />
    <link
      rel="stylesheet"
      href="../../lib/layui-v2.5.5/css/layui.css"
      media="all"
    />
    <!--[if lt IE 9]>
      <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
      <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link
      rel="stylesheet"
      href="../lib/layui-v2.5.5/css/layui.css"
      media="all"
    />
    <link
      rel="stylesheet"
      href="../lib/font-awesome-4.7.0/css/font-awesome.min.css"
      media="all"
    />
    <link rel="stylesheet" href="../css/layuimini.css?v=2.0.1" media="all" />
    <link rel="stylesheet" href="../css/public.css" media="all" />
  </head>
  <body>
    <div class="layuimini-container layuimini-page-anim">
      <script type="text/html" id="toolbar">


        <div style="color:#FF5722;">
            <div>
                <p>注意事项:
                    <ul>
                        <li>
                            1.A条件类型的字段,适合产品或者物料紧密联系的数据,B数据类型的字段,适合产品或者物料的指标数据.
                        </li>
                        <li>
                            2.分组名称相同的可以合并到一个组中.
                        </li>
                        <li>
                            3.排序号只能填写数字.
                        </li>
                    </ul>
                </p>
                <p></p>
                <p></p>
            </div>

        </div>
        <button class="layui-btn layui-btn-sm data-add-btn" lay-event="add"> 保存</button>
      </script>
      <div class="layuimini-main">
        <table
          class="layui-hide"
          id="currentTableId"
          lay-filter="currentTableFilter"
        ></table>
      </div>
    </div>
    <script src="../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
    <script src="../js/lay-config.js?v=2.0.0" charset="utf-8"></script>
    <script>
      layui.use(
        [
          "form",
          "table",
          "element",
          "conf",
          "jquery",
          "miniAdmin",
          "tools",
          "request",
        ],
        function () {
          var $ = layui.jquery,
            tools = layui.tools,
            table = layui.table,
            config = layui.conf,
            request = layui.request,
            miniAdmin = layui.miniAdmin;
          var id = tools.param(location.href, "id");
          loadTable();

          function loadTable() {
            table.render({
              elem: "#currentTableId",
              toolbar: "#toolbar",
              url: config.server + "/api/quality_info/" + id,
              headers: config.headers,
              defaultToolbar: [],
              cols: [
                [
                  { checkbox: true },
                  { field: "type", title: "类型" },
                  { field: "col_name", minWidth: 80, title: "字段代码" },
                  {
                    field: "data_type",
                    minWidth: 80,
                    title: "字段类型",
                  },
                  {
                    edit: true,
                    field: "col_title",
                    minWidth: 80,
                    title: "中文名称",
                  },
                  {
                    edit: true,
                    field: "group_title",
                    minWidth: 80,
                    title: "分组名称",
                  },
                  {
                    edit: true,
                    field: "refer_text",
                    minWidth: 80,
                    title: "指标标准说明",
                  },
                  {
                    edit: true,
                    field: "refer_unit",
                    minWidth: 80,
                    title: "指标单位",
                  },
                  //   {
                  //     edit: true,
                  //     field: "refer_expr",
                  //     minWidth: 80,
                  //     title: "指标标准区间",
                  //   },
                  {
                    edit: true,
                    field: "sort",
                    minWidth: 80,
                    title: "排序号",
                  },
                ],
              ],
              limit: 1000,
              page: false,
              parseData: function (res) {
                //res 即为原始返回的数据
                layui.each(res.data, function (i, item) {
                  item.LAY_CHECKED = item.col_title.trim() != "";
                });
                return res;
              },
              done: function (d) {},
            });
          }
          /**
           * toolbar事件监听
           */
          table.on("toolbar(currentTableFilter)", function (obj) {
            if (obj.event === "add") {
              // 监听添加操作
              var cs = table.checkStatus("currentTableId");
              //检查有空的
              let blank = -1;
              if (
                cs.data.some((item, index, array) => {
                  blank = index;
                  return item.col_title.trim() == "";
                })
              ) {
                miniAdmin.error(
                  "请填写第" +
                    (blank + 1) +
                    "行,字段代码是" +
                    cs.data[blank].col_name
                );
                return false;
              }
              request(
                config.server + "/api/quality_info/" + id,
                "post",
                cs.data
              )
                .then(function (d) {
                  miniAdmin.success(d.msg);
                })
                .catch(function (d) {
                  miniAdmin.error(d.msg);
                });
            }
          });
        }
      );
    </script>
  </body>
</html>
